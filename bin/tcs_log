#!/usr/bin/env ruby

# pool run logs from one batch of tcs jobs
# file structure:
#   batch_tcs_jobs/
#   ├── lib1
#   ├── lib2
#   ├── lib3
#   ├── lib4
#   ├── ...
#
# command example:
#   $ tcs_log batch_tcs_jobs

require 'viral_seq'
require 'pathname'
require 'json'
require 'fileutils'
require 'csv'

indir = ARGV[0].chomp
indir_basename = File.basename(indir)
indir_dirname = File.dirname(indir)

tcs_dir = File.join(indir_dirname, (indir_basename + "_tcs"))
Dir.mkdir(tcs_dir) unless File.directory?(tcs_dir)

libs = []
Dir.chdir(indir) {libs = Dir.glob("*")}
libs.sort_by! {|lib| lib.split("-")[1].to_i}

outdir2 = File.join(tcs_dir, "combined_TCS_per_lib")
outdir3 = File.join(tcs_dir, "TCS_per_region")
outdir4 = File.join(tcs_dir, "combined_TCS_per_region")

Dir.mkdir(outdir2) unless File.directory?(outdir2)
Dir.mkdir(outdir3) unless File.directory?(outdir3)
Dir.mkdir(outdir4) unless File.directory?(outdir4)

log_file = File.join(tcs_dir,"log.csv")
log = File.open(log_file,'w')

header = %w{
  lib_name
  Region
  Raw_Sequences_per_barcode
  R1_Raw
  R2_Raw
  Paired_Raw
  Cutoff
  PID_Length
  Consensus1
  Consensus2
  Distinct_to_Raw
  Resampling_index
  Combined_TCS
  Combined_TCS_after_QC
  Detection_Sensitivity
  WARNINGS
}

### this will be the data for the scatter plot. format as pid_dist_data[lib][region]
### example
### {"RMB10-1"=>{"IN"=>{1=>58, 2=>4, 3=>2, 4=>2, 5=>1, 6=>1, 7=>1, 17=>1}, "RT"=>{1=>2123, 2=>91, 3=>56, 4=>38, 5=>42, 6=>42, 7=>56, 8=>86, 9=>79, 10=>84, 11=>124, 12=>102, 13=>129, 14=>134, 15=>162, 16=>165, 17=>189, 18=>215, 19=>224, 20=>185, 21=>217, 22=>184, 23=>234, 24=>185, 25=>194, 26=>136, 27=>122, 28=>115, 29=>92, 30=>82, 31=>63, 32=>48, 33=>27, 34=>28, 35=>17, 36=>12, 37=>10, 38=>9, 39=>8, 40=>5, 42=>3, 43=>3, 44=>4, 45=>3, 46=>3, 47=>1, 48=>2, 51=>1, 53=>1, 54=>2, 55=>1, 60=>1, 61=>1, 66=>1, 89=>1, 99=>1, 174=>1}, "PR"=>{1=>6053, 2=>386, 3=>112, 4=>69, 5=>47, 6=>41, 7=>51, 8=>50, 9=>40, 10=>45, 11=>48, 12=>69, 13=>82, 14=>71, 15=>89, 16=>103, 17=>123, 18=>116, 19=>104, 20=>146, 21=>152, 22=>146, 23=>161, 24=>205, 25=>216, 26=>252, 27=>295, 28=>292, 29=>356, 30=>331, 31=>381, 32=>371, 33=>392, 34=>417, 35=>314, 36=>364, 37=>378, 38=>311, 39=>263, 40=>249, 41=>248, 42=>210, 43=>177, 44=>151, 45=>132, 46=>101, 47=>82, 48=>63, 49=>49, 50=>29, 51=>28, 52=>22, 53=>16, 54=>11, 55=>15, 56=>11, 57=>6, 58=>7, 59=>8, 60=>4, 61=>6, 62=>3, 63=>5, 64=>1, 65=>4, 66=>2, 67=>9, 68=>6, 69=>3, 70=>2, 71=>11, 72=>7, 73=>7, 74=>10, 75=>4, 76=>11, 77=>2, 78=>5, 79=>3, 80=>1, 81=>3, 83=>1, 84=>1, 86=>1, 87=>2, 89=>1, 92=>2, 93=>1, 95=>2, 96=>1, 101=>2, 106=>1, 108=>2, 110=>1}, "V1V3"=>{1=>56, 2=>21, 3=>10, 4=>6, 5=>6, 6=>4, 7=>3, 8=>2, 9=>3, 11=>2, 13=>2, 15=>2, 17=>1, 19=>1, 20=>1, 25=>1, 28=>1}}, "RMB10-2"=>{"IN"=>{1=>42, 2=>7, 3=>4, 4=>1, 5=>1, 8=>1}, "RT"=>{1=>2608, 2=>1227, 3=>707, 4=>413, 5=>274, 6=>198, 7=>114, 8=>89, 9=>50, 10=>43, 11=>17, 12=>12, 13=>4, 14=>2, 15=>2, 17=>1}, "PR"=>{1=>8829, 2=>762, 3=>217, 4=>107, 5=>115, 6=>65, 7=>81, 8=>74, 9=>64, 10=>90, 11=>95, 12=>114, 13=>135, 14=>149, 15=>155, 16=>185, 17=>217, 18=>255, 19=>277, 20=>332, 21=>398, 22=>437, 23=>533, 24=>569, 25=>585, 26=>656, 27=>733, 28=>738, 29=>710, 30=>703, 31=>718, 32=>628, 33=>610, 34=>581, 35=>508, 36=>475, 37=>414, 38=>344, 39=>248, 40=>224, 41=>171, 42=>133, 43=>110, 44=>85, 45=>74, 46=>62, 47=>46, 48=>42, 49=>23, 50=>23, 51=>21, 52=>24, 53=>25, 54=>32, 55=>23, 56=>20, 57=>24, 58=>15, 59=>29, 60=>27, 61=>21, 62=>17, 63=>14, 64=>20, 65=>18, 66=>16, 67=>21, 68=>10, 69=>10, 70=>7, 71=>8, 72=>8, 73=>7, 74=>7, 75=>4, 76=>11, 77=>2, 78=>5, 79=>3, 80=>2, 81=>1, 82=>2, 83=>2, 84=>3, 86=>1, 89=>1, 90=>1, 91=>1, 93=>1, 95=>1, 96=>1, 97=>1, 98=>1, 99=>1, 105=>1, 106=>1, 108=>1, 109=>1, 110=>1, 114=>1, 123=>2, 131=>1}, "V1V3"=>{1=>840, 2=>156, 3=>190, 4=>273, 5=>294, 6=>336, 7=>385, 8=>387, 9=>329, 10=>255, 11=>188, 12=>161, 13=>95, 14=>59, 15=>33, 16=>29, 17=>8, 18=>6, 19=>4, 21=>1, 22=>2, 24=>1, 32=>1}}, "RMB10-3"=>{"IN"=>{1=>52, 2=>7, 3=>1, 5=>1, 9=>1, 11=>1, 30=>1, 31=>1, 45=>1, 51=>1, 135=>1, 159=>1}, "RT"=>{1=>232, 2=>84, 3=>34, 4=>10, 5=>6, 6=>1, 7=>2, 8=>3, 9=>1, 10=>1, 11=>1, 13=>1, 16=>1, 24=>1, 28=>1, 30=>1, 32=>1, 490=>1, 662=>1, 874=>1, 884=>1, 909=>1, 921=>1, 1013=>1, 1048=>1, 1063=>1, 1158=>1, 1172=>1, 1173=>1, 1205=>1, 1225=>1, 1228=>1, 1305=>1, 1329=>1, 1336=>1, 1497=>1, 2227=>1}, "PR"=>{1=>910, 2=>180, 3=>104, 4=>53, 5=>36, 6=>19, 7=>11, 8=>10, 9=>6, 10=>2, 11=>8, 12=>1, 13=>4, 14=>2, 15=>3, 16=>1, 17=>1, 18=>1, 19=>2, 20=>1, 21=>1, 22=>2, 23=>1, 24=>1, 29=>2, 33=>1, 45=>1, 46=>1, 48=>1, 64=>1, 68=>1, 80=>1, 162=>1, 232=>1, 843=>1, 1027=>1, 1076=>1, 1079=>1, 1142=>1, 1251=>1, 1313=>1, 1456=>1, 1671=>1, 1801=>1, 1805=>1, 1831=>1, 1840=>1, 1924=>1, 1973=>1, 1996=>1, 2177=>1, 2192=>1, 2218=>1, 2241=>1, 2257=>1, 2299=>1, 2322=>1, 2329=>1, 2380=>1, 2427=>1, 2529=>1, 2549=>1, 2558=>1, 2562=>1, 2563=>1, 2578=>1, 2618=>1, 2630=>1, 2666=>1}, "V1V3"=>{1=>27, 2=>4, 3=>3, 4=>1, 6=>3, 44=>1, 69=>1, 119=>1, 621=>1, 841=>1}}, "RMB10-4"=>{"IN"=>{1=>671, 2=>174, 3=>84, 4=>47, 5=>39, 6=>38, 7=>33, 8=>31, 9=>29, 10=>23, 11=>22, 12=>19, 13=>19, 14=>13, 15=>21, 16=>18, 17=>5, 18=>13, 19=>7, 20=>6, 21=>5, 22=>6, 23=>4, 24=>2, 25=>3, 26=>2, 28=>2, 29=>1, 31=>1, 35=>1, 52=>1}, "RT"=>{1=>665, 2=>67, 3=>52, 4=>50, 5=>53, 6=>65, 7=>97, 8=>97, 9=>114, 10=>109, 11=>140, 12=>107, 13=>109, 14=>88, 15=>100, 16=>75, 17=>64, 18=>44, 19=>56, 20=>47, 21=>36, 22=>29, 23=>26, 24=>13, 25=>17, 26=>4, 27=>5, 28=>7, 29=>4, 30=>5, 31=>2, 32=>2, 33=>2, 35=>1, 37=>1, 38=>1, 49=>1}, "PR"=>{1=>5242, 2=>385, 3=>67, 4=>45, 5=>34, 6=>21, 7=>25, 8=>16, 9=>17, 10=>11, 11=>9, 12=>14, 13=>14, 14=>16, 15=>11, 16=>24, 17=>21, 18=>17, 19=>18, 20=>16, 21=>28, 22=>38, 23=>34, 24=>36, 25=>45, 26=>47, 27=>50, 28=>45, 29=>47, 30=>44, 31=>50, 32=>44, 33=>43, 34=>58, 35=>61, 36=>54, 37=>58, 38=>66, 39=>62, 40=>63, 41=>83, 42=>73, 43=>109, 44=>95, 45=>124, 46=>115, 47=>128, 48=>144, 49=>139, 50=>140, 51=>141, 52=>159, 53=>141, 54=>180, 55=>158, 56=>142, 57=>157, 58=>166, 59=>136, 60=>131, 61=>117, 62=>103, 63=>81, 64=>96, 65=>76, 66=>65, 67=>71, 68=>47, 69=>43, 70=>44, 71=>39, 72=>26, 73=>29, 74=>21, 75=>18, 76=>11, 77=>9, 78=>10, 79=>6, 80=>3, 81=>3, 82=>4, 83=>3, 84=>3, 85=>2, 86=>3, 87=>3, 88=>1, 90=>2, 91=>1, 92=>1, 93=>3, 94=>1, 95=>2, 96=>3, 98=>3, 99=>1, 102=>2, 104=>1, 105=>2, 106=>1, 107=>2, 108=>4, 109=>3, 110=>1, 112=>2, 113=>2, 114=>2, 115=>3, 116=>1, 117=>2, 118=>1, 119=>1, 121=>1, 123=>1, 124=>2, 126=>1, 127=>1, 128=>1, 132=>1, 134=>2, 138=>1, 144=>2}, "V1V3"=>{1=>2292, 2=>95, 3=>45, 4=>52, 5=>56, 6=>59, 7=>82, 8=>91, 9=>122, 10=>147, 11=>171, 12=>203, 13=>222, 14=>268, 15=>255, 16=>264, 17=>291, 18=>274, 19=>264, 20=>231, 21=>223, 22=>186, 23=>172, 24=>162, 25=>120, 26=>96, 27=>85, 28=>65, 29=>48, 30=>28, 31=>31, 32=>23, 33=>8, 34=>12, 35=>9, 36=>7, 37=>3, 38=>1}}}

pid_dist_data = {}

log.puts header.join(',')
libs.each do |lib|
  Dir.mkdir(File.join(outdir2, lib)) unless File.directory?(File.join(outdir2, lib))
  fasta_files = []
  json_files = []
  pid_json_files = []
  pid_dist_data[lib] = {}

  Dir.chdir(File.join(indir, lib)) do
     fasta_files = Dir.glob("**/*.fasta")
     json_files = Dir.glob("**/log.json")
     pid_json_files = Dir.glob("**/primer_id.json")
  end

  fasta_files.each do |f|
    path_array = Pathname(f).each_filename.to_a
    region = path_array[0]
    if path_array[-1] == "combined.fasta"
      FileUtils.cp(File.join(indir, lib, f), File.join(outdir2, lib, (lib + "_" + region)))
      Dir.mkdir(File.join(outdir4,region)) unless File.directory?(File.join(outdir4,region))
      FileUtils.cp(File.join(indir, lib, f), File.join(outdir4, region, (lib + "_" + region)))
    else
      Dir.mkdir(File.join(outdir3,region)) unless File.directory?(File.join(outdir3,region))
      Dir.mkdir(File.join(outdir3,region, lib)) unless File.directory?(File.join(outdir3,region, lib))
      FileUtils.cp(File.join(indir, lib, f), File.join(outdir3, region, lib, (lib + "_" + region + "_" + path_array[-1])))
    end
  end

  json_files.each do |f|
    json_log = JSON.parse(File.read(File.join(indir, lib, f)), symbolize_names: true)
    tcs_number = json_log[:total_tcs]
    if json_log[:combined_tcs]
      tcs_number = json_log[:combined_tcs]
      if json_log[:combined_tcs_after_qc]
        tcs_number = json_log[:combined_tcs_after_qc]
      end
    end

    log.print [lib,
               json_log[:primer_set_name],
               json_log[:total_raw_sequence],
               json_log[:r1_filtered_raw],
               json_log[:r2_filtered_raw],
               json_log[:paired_raw_sequence],
               json_log[:consensus_cutoff],
               json_log[:length_of_pid],
               json_log[:total_tcs_with_ambiguities],
               json_log[:total_tcs],
               json_log[:distinct_to_raw],
               json_log[:resampling_param],
               json_log[:combined_tcs],
               json_log[:combined_tcs_after_qc],
               ViralSeq::TcsCore::detection_limit(tcs_number.to_i),
               json_log[:warnings],
             ].join(',') + "\n"
  end

  pid_json_files.each do |f|
    pid_json = JSON.parse(File.read(File.join(indir, lib, f)), symbolize_names: true)
    region = Pathname(f).each_filename.to_a[-2]
    pid_dist = {}
    pid_json[:primer_id_distribution].each {|k,v| pid_dist[k.to_s.to_i] = v}
    pid_dist_data[lib][region] = pid_dist
  end
end
log.close

# Create HTML page with charts from log.csv above

class String
    def var_safe
        gsub '-',''
    end
    def shorten_html
        gsub /\n/, ''
        gsub /\t/, ''
    end
end

colors = ["#332288", "#117733", "#44AA99", "#88CCEE", "#DDCC77", "#CC6677", "#AA4499", "#882255"]
bool_colors = { true => colors[3], false => colors[5] }

#hold vars for csv input
raw_sequence_data = ["['Library Name', 'Raw Sequences', { role: 'annotation' }]"]
lib_names = []
total_reads = 0
max_region_char_length = 5
lib_data = {}
batch_name = ""
region_colors = {"Other" => "#808080"}

CSV.foreach(log_file).each_with_index do |row, i|
    next if i == 0 || row[0] == nil

    lib_name = row[0]
    region = row[1]
    raw_sequences_per_barcode = row[2].to_i

    if not region_colors.key?(region)
        region_colors[region] = colors[region_colors.length % (colors.length - 1)]
    end

    if region.length > max_region_char_length + 2
        max_region_char_length = region.length + 2
    end

    if batch_name == ""
        batch_name = lib_name.split('-')[0]
    end

    if not lib_names.include? lib_name
        lib_names.push(lib_name)
        total_reads += raw_sequences_per_barcode
        raw_sequence_data.push("['#{lib_name}', #{raw_sequences_per_barcode}, '#{raw_sequences_per_barcode}']")
        lib_data[lib_name] = {}
    end

    lib_data[lib_name][region] = {
        'lib_name' => lib_name,
        'region' => region,
        'raw_sequences_per_barcode' => raw_sequences_per_barcode,
        'r1_raw' => row[3].to_i,
        'r2_raw' => row[4].to_i,
        'paired_raw' => row[5].to_i,
        'cut-off' => row[6].to_i, # need to plot the cut-off value as an absolute vertical line on the scatter plot.
        'consensus2' => row[9].to_i,
        'distinct_to_raw' => row[10].to_f,
        'resampling_index' => row[11].to_f,
        'combined_TCS' => row[12].to_i,
        'combined_TCS_after_QC' => row[13].to_i,
        'detection_sensitivity' => row[14].to_f,
        'warnings' => row[15].to_s || ""
    }
end

#format output
total_reads = total_reads.to_s.reverse.gsub(/(\d{3})(?=\d)/, '\\1,').reverse
raw_sequence_data = "[" + raw_sequence_data.join(',') + "]"
lib_names = lib_names.sort_by { |s| [s.split("-")[0], s.split("-")[1].to_i] }

#calculate 'other'
lib_data.each do |lib, data|
    sum = data.values.reduce(0) { |sum, obj| sum + obj['paired_raw'] }
    raw_sequences_per_barcode = data[data.keys.first]['raw_sequences_per_barcode']


    other = raw_sequences_per_barcode - sum
    data['other'] = {
        "region" => "Other",
        "paired_raw" => other,
        "raw_sequences_per_barcode" => raw_sequences_per_barcode
    }
end

#process each library's html
library_links = "
    <ul>
        <li id='link_basic-statistics' class='pointer current_page' onclick='showPage(\"basic-statistics\")'>Basic Statistics</li>
        <li>Libraries
            <ul>" + lib_names.map { |lib_name| "
                <li id='link_#{lib_name}' class='pointer' onclick='showPage(\""+lib_name+"\")'>"+lib_name+"</li>"
                }.join + "
            </ul>
        </li>
    </ul>
"

library_pages = lib_names.map { |lib_name|
    "<div id='"+lib_name+"' class='page hidden' style='display: flex; gap: 16px; flex-direction: column;'>
        <div style='flex: 1; display: flex; flex-direction: column; gap: 16px;'>
            <div class='error-message'></div>
            <div style='display: flex;'>
                <div style='align-self: center; flex: 1; display: flex; flex-direction: column; gap: 16px;'>
                    <div style='align-self: center;'>
                        <h2>Distribution of Raw Sequencing Reads</h2>
                    </div>
                    <div class='pie_chart'></div>
                </div>
                <div style='display: flex; align-items: center; flex-direction: column; flex: 1;'>
                    " + lib_data[lib_name].map{ |lib, data| data['region'] == "Other" ? "" : "
                        <div class='#{data['region']}' style='display: flex; flex-direction: row; align-items: center;'>
                            <div style='width: #{max_region_char_length.to_s}ch;'>#{data['region']}</div>
                            <div class='treemap' style='flex: 1; height: #{80 / (lib_data[lib_name].length - 1)}vh;'></div>
                        </div>
                    " }.join + "
                </div>
            </div>
        </div>
        <div style='flex: 1; display: flex; flex-direction: column; gap: 16px;'>
            <div style='align-self: center;'>
                <h2>Number of TCS at Regions</h2>
            </div>
            <div class='tcs_bar_chart' style='flex: 1;'></div>
            <div class='tcs_warnings' style='flex: 1; margin-left: 24px;'></div>
            <div style='align-self: center;'>
                <h2>Detection Sensitivity Title</h2>
            </div>
            <div class='detection_sensitivity_chart' style='flex: 1;'></div>
            <div style='align-self: center;'>
                <h2 style='text-align: center;'>Distinct to Raw</h2>
                <p><i>Distinct to Raw greater than 0.1 suggests more raw sequences are required to fully recover TCS</i></p>
            </div>
            <div class='raw_bar_chart' style='flex: 1;'></div>
            <div style='align-self: center;'>
                <h2 style='text-align: center;'>Resampling Index</h2>
                <p><i>Resampling index less than 0.9 suggests Primer ID resampling</i></p>
            </div>
            <div class='resampling_bar_chart' style='flex: 1;'></div>
        </div>
    </div>"
}

#format lib_data into charts
paired_raw = {}
tree_charts = {}
tcs_bar_chart = {}
distinct_bar_chart = {}
resampling_bar_chart = {}
detection_sensitivity_chart = {}

lib_data.each do |lib, data|
    paired_raw[lib] = {}

    paired_raw[lib]['data'] = "
        [
            ['Region', 'Paired Raw'], " +
            data.map { |lib, d| "
                ['#{d['region']},#{d['paired_raw']}', #{d['paired_raw']}],
            " }.join + "
        ]
    "

    paired_raw[lib]['slices'] = "[#{
        data.map{ |lib, d| "{color: '#{region_colors[d['region']]}'}" }.join(',')
    }]"

    paired_raw[lib]['residuel_text'] = data.map { |lib, d|
        (d['paired_raw'].to_f / d['raw_sequences_per_barcode'].to_f) < (0.5/360) ?
            "#{d['region']},#{d['paired_raw']}" :
            nil
    }.compact.join(" - ")

    tree_charts[lib] = {}
    data.each do |region, d|
        if region != "other"
            tree_charts[lib][region] = "
                [
                    ['Location', 'Parent', 'r'],
                    ['Global', null,0],
                    ['R1_Raw', 'Global', #{d['r1_raw'].to_s}],
                    ['R2_Raw', 'Global', #{d['r2_raw'].to_s}],
                    ['Paired_Raw', 'Global', #{d['paired_raw'].to_s}],
                ]
            "
        end
    end

    has_c = data.values.inject(0) {|sum, h| sum + (h['combined_TCS'] == nil ? 0 : h['combined_TCS']) } > 0
    has_qc = data.values.inject(0) {|sum, h| sum + (h['combined_TCS_after_QC'] == nil ? 0 : h['combined_TCS_after_QC']) } > 0

    tcs_bar_chart[lib] = {
        'data' => "
            [
                [
                    'Region',
                    'TCS',
                    #{has_c ? "'Combined TCS'," : ''}
                    #{has_qc ? "'TCS After QC'," : ''}
                ],
                " + data.map{ |region, d| d['region'] === "Other" ? "" : "
                [
                    '#{d['region']}#{d['warnings'].length > 0 ? '*' : ''}',
                    #{d['consensus2']}  ,
                    #{has_c ? "#{d['combined_TCS']}," : ''}
                    #{has_qc ? "#{d['combined_TCS_after_QC']}," : ''}
                ],
                " }.join + "
            ]
        ",
        'warnings' => data.map{ |region, d|
            d['region'] != "Other" && d['warnings'].length > 0 ? "#{region} - #{d["warnings"]}<br/>" : ''
        }.join
    }

    detection_sensitivity_chart[lib] = "[
        ['Region', 'Detection Sensitivity'],
        #{ data.map{ |region, d|
            d['region'] == 'Other' ? "" : "['#{d['region']}', #{d['detection_sensitivity']}]"
        }.join(',') }
    ]"

    distinct_bar_chart[lib] = "
        [
            ['Region','Distinct to Raw', {role: 'style'}],
            "+ data.map{ |region, d| d['region'] == 'Other' ? "" : "
            [
                '#{d['region']}', #{d['distinct_to_raw']}, '#{bool_colors[d['distinct_to_raw'].to_f < 0.1]}'
            ],"}.join + "
        ]
    "

    resampling_bar_chart[lib] = "
        [
            ['Region','Resampling Index', {role: 'style'}],
            "+ data.map{ |region, d| d['region'] == 'Other' ? "" : "
            [
                '#{d['region']}', #{d['resampling_index']}, '#{bool_colors[d['resampling_index'].to_f > 0.9]}'
            ]," }.join + "
        ]
    "
end

#create JS that initializes charts
paired_raw_js = paired_raw.map { |lib, data| '
    var element_pie_'+lib.var_safe+' = document.querySelector("#'+lib+' .pie_chart")
    if(isVisible(element_pie_'+lib.var_safe+')){
        var chart_pie_'+lib.var_safe+' = new google.visualization.PieChart(element_pie_'+lib.var_safe+');
        chart_pie_'+lib.var_safe+'.draw(
            google.visualization.arrayToDataTable('+data['data']+'),
            {
                title: "Paired Raw",
                titleTextStyle: {
                    fontSize: 18
                },
                height,
                width: Math.round(width * .5),
                pieSliceText: "label",
                slices: ' + data['slices'] + ',
                legend: {
                    position: "left",
                    alignment: "center"
                },
                chartArea: {
                    width: "100%",
                    height: "100%"
                },
                ' + (data['residuel_text'].length > 0 ? "pieResidueSliceLabel: '#{data['residuel_text']}'" : "") + '
            }
        );
    }
' }.join

tree_charts_js = tree_charts.map { |lib, d|
    d.map { |region, data| '
        var element_chart_tree_'+lib.var_safe+'_'+region.var_safe+' = document.querySelector("#'+lib+' .'+region+' .treemap")
        if(isVisible(element_chart_tree_'+lib.var_safe+'_'+region.var_safe+')){
            var chart_tree_'+lib.var_safe+'_'+region.var_safe+' = new google.visualization.TreeMap(element_chart_tree_'+lib.var_safe+'_'+region.var_safe+');
            chart_tree_'+lib.var_safe+'_'+region.var_safe+'.draw(
                google.visualization.arrayToDataTable('+data+'),
                {
                    headerHeight: 0,
                    minColor: "' + colors[1] + '",
                    maxColor: "' + colors[5] + '",
                    fontColor: "#fff",
                }
            );
            google.visualization.events.addListener(chart_tree_'+lib.var_safe+'_'+region.var_safe+', "select", function () {
                chart_tree_'+lib.var_safe+'_'+region.var_safe+'.setSelection([]);
            });
        }
    '}
}.join

tcs_bar_chart_js = tcs_bar_chart.map { |lib, data| '
    var element_tcs_bar_chart_'+lib.var_safe+' = document.querySelector("#'+lib+' .tcs_bar_chart")
    if(isVisible(element_tcs_bar_chart_'+lib.var_safe+')){
        var tcs_bar_chart_'+lib.var_safe+' = new google.charts.Bar(element_tcs_bar_chart_'+lib.var_safe+');
        tcs_bar_chart_'+lib.var_safe+'.draw(
            google.visualization.arrayToDataTable('+data["data"]+'),
            google.charts.Bar.convertOptions({
                chart: {
                    title: "TCS",
                },
                colors: ["' + colors[0] + '", "' + colors[1] + '", "' + colors[2] + '"],
                legend: { position: "bottom" },
                width,
                height,
                chartArea: {
                    width: "100%",
                    height: "100%"
                }
            })
        );
        document.querySelector("#'+lib+' .tcs_warnings").innerHTML = "'+data['warnings']+'";
    }
' }.join

detection_sensitivity_js = detection_sensitivity_chart.map { |lib, data| '
    var element_detection_'+lib.var_safe+' = document.querySelector("#'+lib+' .detection_sensitivity_chart")
    if(isVisible(element_detection_'+lib.var_safe+')){
        var detection_'+lib.var_safe+' = new google.visualization.ColumnChart(element_detection_'+lib.var_safe+');
        detection_'+lib.var_safe+'.draw(
            google.visualization.arrayToDataTable('+data+'),
            {
                legend: {
                    position: "none"
                },
                width,
                height
            }
        );
    }
'}.join

distinct_bar_chart_js = distinct_bar_chart.map { |lib, data| '
    var element_distinct_'+lib.var_safe+' = document.querySelector("#'+lib+' .raw_bar_chart")
    if(isVisible(element_distinct_'+lib.var_safe+')){
        var distinct_'+lib.var_safe+' = new google.visualization.ColumnChart(element_distinct_'+lib.var_safe+');
        distinct_'+lib.var_safe+'.draw(
            google.visualization.arrayToDataTable('+data+'),
            {
                legend: {
                    position: "none"
                },
                width,
                height
            }
        );
    }
' }.join

resampling_bar_chart_js = resampling_bar_chart.map { |lib, data| '
    var element_resampling_'+lib.var_safe+' = document.querySelector("#'+lib+' .resampling_bar_chart")
    if(isVisible(element_resampling_'+lib.var_safe+')){
        var resampling_'+lib.var_safe+' = new google.visualization.ColumnChart(element_resampling_'+lib.var_safe+');
        resampling_'+lib.var_safe+'.draw(
            google.visualization.arrayToDataTable('+data+'),
            {
                legend: {
                    position: "none"
                },
                width,
                height
            }
        );
    }
' }.join

html = '
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TCS Log</title>
        <script src="https://www.gstatic.com/charts/loader.js"></script>
        <script>
            google.charts.load("current", {packages: ["corechart", "treemap", "bar"]});
            google.charts.setOnLoadCallback(drawChart);

            var isInit = false

            function isVisible(el) {
                return (el.offsetParent !== null)
            }

            function drawChart() {

                document.querySelectorAll(".error-message").forEach(element => element.innerHTML = "")

                if(! isInit){
                    isInit = true;
                    window.onresize = drawChart;
                }

                try{
                    var width = Math.round(window.innerWidth * .8)
                    var height = Math.round(window.innerHeight * .6)

                    var element_home_chart = document.getElementById("raw-sequence-chart")
                    if(isVisible(element_home_chart)){
                        var home_chart = new google.visualization.ColumnChart(element_home_chart);
                        home_chart.draw(
                            google.visualization.arrayToDataTable('+raw_sequence_data+'),
                            {
                                width,
                                height,
                                annotations: {alwaysOutside: true}
                            }
                        );
                    }'+ paired_raw_js + tree_charts_js + tcs_bar_chart_js + distinct_bar_chart_js + resampling_bar_chart_js + detection_sensitivity_js + '
                }catch(e){
                    document.querySelectorAll(".error-message").forEach(element =>
                        element.innerHTML = "There was an error with your data.<br>To help us improve, please forward this html file to shuntaiz@email.unc.edu"
                    )
                }
            }

            function showPage(pageID){
                document.querySelectorAll(".page").forEach(element => element.classList.add("hidden"))
                document.getElementById(pageID).classList.remove("hidden")

                document.querySelectorAll(".current_page").forEach(element => element.classList.remove("current_page"));
                document.getElementById("link_"+pageID).classList.add("current_page");

                drawChart();
            }
        </script>
    </head>
    <body>
        <div style="display: flex; flex-direction: column; height: 100vh; width: 100vw; position: fixed; overflow: hidden;">
            <div style="height: 10vh; border-bottom: 2px solid blue;">
                <p style="font-size: 2rem; margin: 16px 24px;">TCS Log</p>
            </div>
            <div style="display: flex; flex: 1;">
                <div id="nav" style="overflow: auto; height: 90vh; text-align: left; border-right: 2px solid blue; padding: 10px; padding-right: 20px;">
                    '+library_links+'
                </div>
                <div id="pages" style="flex: 1; overflow: auto; height: 90vh;">
                    <div style="display: flex; flex-direction: column; align-items: center;" id="basic-statistics" class="page">
                        <div class="error-message"></div>
                        <table id="home-table">
                            <tr>
                                <td>Batch Name</td>
                                <td>'+batch_name+'</td>
                            </tr>
                            <tr>
                                <td>Processed Time</td>
                                <td>'+Time.now.strftime("%m/%d/%Y")+'</td>
                            </tr>
                            <tr>
                                <td>TCS Version</td>
                                <td>'+ViralSeq::TCS_VERSION+'</td>
                            </tr>
                            <tr>
                                <td>viral_seq Version</td>
                                <td>'+ViralSeq::VERSION+'</td>
                            </tr>
                            <tr>
                                <td>Number of Libraries</td>
                                <td>'+lib_names.length.to_s+'</td>
                            </tr>
                            <tr>
                                <td>Total Reads</td>
                                <td>'+total_reads+'</td>
                            </tr>
                        </table>
                        <div>
                            <p style="font-size: 1.8rem;">Raw Sequences Distribution</p>
                        </div>
                        <div id="raw-sequence-chart"></div>
                    </div>
                    '+library_pages.join+'
                </div>
            </div>
        </div>
    </body>
    <style>
        body {
            font-size: 1.2rem;
            color: #333;
        }
        #nav ul {
            list-style-type: none;
        }
        .page {
            margin: 32px;
        }
        .hidden {
            display: none !important;
            visibility: hidden !important;
        }
        .pointer {
            cursor: pointer;
        }
        #home-table {
            margin: 0 auto;
            width: 80%;
            border-collapse: collapse;
        }
        #home-table, #home-table th, #home-table td {
            border: 1px solid black;
        }
        #home-table td {
            padding: 8px;
        }
        .current_page {
            border-bottom: 1px solid blue;
        }
        .error-message {
            background: red !important;
            color: white;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1.8rem;
            text-align: center;
            padding: 1%;
        }
        .error-message:empty {
            display: none;
        }
    </style>
</html>
'.shorten_html

File.open(File.join(tcs_dir,"log.html"), 'w') { |file| file.write(html) }
